let recognition;
let recognizing = false;

if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  // CRITICAL FIXES:
  recognition.continuous = true;        // keeps the mic open
  recognition.stop();                   // ensure clean state

  recognition.onstart = () => {
    recognizing = true;
    micButton.textContent = "ðŸŽ™ï¸ Listening...";
  };

  recognition.onend = () => {
    recognizing = false;
    micButton.textContent = "ðŸŽ™ï¸ Speak";
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error:", event.error);
    recognizing = false;
    micButton.textContent = "ðŸŽ™ï¸ Speak";
  };

  recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript;
    userTextSpan.textContent = transcript;
    sendToElena(transcript);
  };
}

micButton.onclick = () => {
  if (!recognition) return;

  // Force mic permission prompt
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(() => {
      if (!recognizing) {
        recognition.start();
      } else {
        recognition.stop();
      }
    })
    .catch(err => {
      console.error("Microphone permission denied:", err);
    });
};
